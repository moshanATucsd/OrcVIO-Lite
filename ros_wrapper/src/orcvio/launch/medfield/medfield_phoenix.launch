<?xml version="1.0"?>
<launch>

  <arg name="name" default="acl_jackal"/>
  <arg name="robot" default="orcvio_robot"/>
  <arg name="fixed_frame_id" default="world"/>

  <!-- bag parameters -->
  <arg name="path_bag" default="/media/erl/disk1/dcist_vio/dcist_cde_bags/kimera_big_loop_2021-05-04-16-40-46.bag" />
  
  <arg name="visualize_rviz" default="true" />

  <!-- evaluation mode is used to compare the results of different flags -->
  <!-- <arg name="evaluation_mode" default="true" />   -->
  <arg name="evaluation_mode" default="false" />

    <!-- play the dataset -->
    <node pkg="rosbag" type="play" name="rosbag" args="--clock --delay 2 $(arg path_bag)" required="false">
      <remap from="/tf" to="/tf_old" />
    </node>

  <node name="republish" type="republish" pkg="image_transport" output="screen" args="compressed in:=/$(arg name)/forward/infra1/image_rect_raw out:=/$(arg name)/forward/color/image_rect" /> 
  <!-- node name="republish" type="republish" pkg="image_transport" output="screen" args="compressed in:=/camera/infra1/image_rect_raw raw out:=/acl_jackal/forward/color/image_rect" / -->

  <!-- System Manager Nodelet  -->
  <group ns="$(arg robot)">
    <node pkg="nodelet" type="nodelet" name="system"
      args='standalone orcvio/SystemNodelet'
      output="screen">

      <param name="fixed_frame_id" value="$(arg fixed_frame_id)"/>

      <!-- remap from="~imu" to="/camera/imu"/ -->
      <remap from="~imu" to="/acl_jackal/forward/imu"/>
      <remap from="~cam0_image" to="/acl_jackal/forward/color/image_rect"/>

      <param name="config_file" value="$(find orcvio)/../../../config/jackal_phoenix.yaml"/>
      <param name="result_file" value="$(find orcvio)/../../../cache/temp_rmse.txt"/>

      <param name="evaluation_mode_flag" type="int" value="1" if="$(arg evaluation_mode)"/>
      <param name="evaluation_mode_flag" type="int" value="0" unless="$(arg evaluation_mode)"/>


      <param name="load_groundtruth_flag" type="int" value="0"/>
      <!-- <param name="use_left_perturbation_flag" type="int" value="1" /> -->

    </node>
  </group>
    
    <!-- open rviz  -->
    <group if="$(arg visualize_rviz)" >
      <node pkg="tf" type="static_transform_publisher" name="tf_world_to_global" args="0.0 0.0 0.0 0.0 0.0 0.0 1.0 world global 1000"/>
      <node type="rviz" name="rviz" pkg="rviz" args="-d $(find orcvio)/launch/rviz/orcvio_medfield_phoenix_object.rviz" />
    </group>
    <arg name="vis_robot_model" default="true" />
    <group if="$(arg vis_robot_model)">
      <param name="robot_description"
             command="$(find warthog_description)/scripts/env_run
                      $(find warthog_description)/urdf/configs/base
                      $(find xacro)/xacro $(find warthog_description)/urdf/warthog.urdf.xacro
                      --inorder" />
      <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher" >
        <param name="tf_prefix" value="$(arg name)" />
      </node>
      <!-- node pkg="tf" type="static_transform_publisher" name="tf_base_to_link" args="0.0 0.0 0.0 0.0 0.0 0.0 1.0 $(arg name)/forward_link $(arg name)/base_link 1000"/-->
    </group>
</launch>
